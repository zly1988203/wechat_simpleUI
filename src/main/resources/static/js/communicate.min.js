!function(e){if(!("WebSocket"in window))throw"浏览器版本过低，不支持websocket，请升级重试";var t={url:"",openCallback:null,closeCallback:null,errorCallback:null,messageCallback:null,keepalive:10,receiveMessageTimer:30,autoReconnect:!0},r=null,a=null,n=null,o=null,c=function(e){if("object"!=typeof e)throw"参数必须为对象";for(var r in a=t,e)for(var n in a)n===r&&(a[n]=e[r]);return this};c.prototype.init=function(){r=new WebSocket(a.url),c.bind()},c.bind=function(){var e=this;function t(e){var t="";switch(e){case 0:t="连接还没开启";break;case 1:t="连接已开启并准备好进行通信";break;case 2:t="连接正在关闭的过程中";break;case 3:t="连接已经关闭，或者连接无法建立"}return t}r.addEventListener("open",function(r){if(clearTimeout(n),o&&o.hasOwnProperty("tmpMessage")){var c=new ArrayBuffer(o.tmpMessage).slice(0,o.bufferedAmount);o.send(c)}else o=null;if("function"==typeof a.openCallback){var i=r.currentTarget,l=t(i.readyState);a.openCallback.bind(e.prototype,{url:i.url,readyStateText:l})()}}),r.addEventListener("close",function(r){if("function"==typeof a.closeCallback){var n=r.currentTarget,o=t(n.readyState),c=function(e){var t="";switch(e){case 1e3:t="正常关闭; 无论为何目的而创建, 该链接都已成功完成任务";break;case 1001:t="终端离开, 可能因为服务端错误, 也可能因为浏览器正从打开连接的页面跳转离开";break;case 1002:t="由于协议错误而中断连接";break;case 1003:t="由于接收到不允许的数据类型而断开连接 (如仅接收文本数据的终端接收到了二进制数据)";break;case 1005:t="表示没有收到预期的状态码"}return t}(r.code);a.closeCallback.bind(e.prototype,{url:n.url,codeText:c,reason:r.reason,wasClean:r.wasClean,readyStateText:o})()}a.autoReconnect&&e.prototype.reconnect()}),r.addEventListener("message",function(r){if(clearTimeout(n),"function"==typeof a.messageCallback){var o=t(r.currentTarget.readyState),c=r.data;try{c=JSON.parse(c)}catch(e){}a.messageCallback.bind(e.prototype,{data:c,origin:r.origin,readyStateText:o})()}}),r.addEventListener("error",function(r){"function"==typeof a.errorCallback&&a.errorCallback.bind(e.prototype,t(r.currentTarget.readyState))(),a.autoReconnect&&e.prototype.reconnect()})},c.prototype.send=function(e){if(null==r)return"function"==typeof a.errorCallback&&a.errorCallback("通讯暂未建立，建立通讯：Communicate.init"),this;var t=this,o=null;switch(r.readyState){case WebSocket.CONNECTING:o="通讯正在建立，请稍后";break;case WebSocket.OPEN:case WebSocket.CLOSING:break;case WebSocket.CLOSED:o="通讯已关闭，无法发送数据"}if(o)return"function"==typeof a.errorCallback&&a.errorCallback(o),this;var c=e;"object"==typeof e&&(c=JSON.stringify(c)),r.send(c),n=setTimeout(function(){t.reconnect(c)},1e3*a.receiveMessageTimer)},c.prototype.close=function(){if(null==r)return"function"==typeof a.errorCallback&&a.errorCallback("通讯暂未建立，建立通讯：Communicate.init"),this;r.close()},c.prototype.reconnect=function(e){var t=this;if(0!==r.bufferedAmount||r.readyState==WebSocket.CLOSING||r.readyState==WebSocket.CLOSED)for(var n=0;n<a.keepalive;n++)setTimeout(function(){n!=a.keepalive||0===r.bufferedAmount&&r.readyState!=WebSocket.CLOSING&&r.readyState!=WebSocket.CLOSED||((o=t).bufferedAmount=r.bufferedAmount,e&&(o.tmpMessage=e),t.close(),a.errorCallback&&"function"==typeof a.errorCallback&&a.errorCallback.bind(t.prototype,"正在重连")(),t.init())},1e3)},e.communicate=c}(window);